<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>黴菌軍團</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <script>
        const stage = new Phaser.Class({

            Extends: Phaser.Scene,
            initialize: function stage() {

                Phaser.Scene.call(this, {
                    type: Phaser.AUTO,
                    scale: {
                        //mode: Phaser.Scale.FIT,
                        autoCenter: Phaser.Scale.CENTER_BOTH,
                        width: 1000,
                        height: 600
                    },
                    physics: {
                        default: "arcade",
                        arcade: {
                            gravity: {
                                y: 300
                            },
                            debug: false,
                        },
                    },
                    key: "stage"
                });
            },
            preload: function () {
                this.load.image("bg", "./assets/img/background.png")
                this.load.image("lilmold", "./assets/img/lilmold.png")
                this.load.image("bubble", "./assets/img/bubble.png")
                this.load.image("soap", "./assets/img/soap.png")
                this.load.image("platform1", "./assets/img/platform1.png")
                this.load.image("line1", "./assets/img/line1.png")
                this.load.image("line2", "./assets/img/line2.png")
                this.load.image("line3", "./assets/img/line3.png")
                this.load.image("line4", "./assets/img/line4.png")
                this.load.image("line5", "./assets/img/line5.png")
                this.load.image("on", "./assets/img/voiceon.png");
                this.load.image("off", "./assets/img/voiceoff.png");
                this.load.image("restart", "./assets/img/restart.png");
                this.load.image("restart-2", "./assets/img/restart-2.png");
                this.load.spritesheet('mold', './assets/img/mold.png', {
                    frameWidth: 83,
                    frameHeight: 55
                })
                this.load.image('bullet', './assets/img/bullet.png')
                this.load.audio("menu", "./assets/audio/menu.mp3")
                this.load.audio("level1", "./assets/audio/level1bgm.mp3")
                this.load.audio("losesound", "./assets/audio/Losesound.mp3")
                this.load.audio("ouch", "./assets/audio/ouch.mp3")
                this.load.audio("coin", "./assets/audio/coin01.mp3")

            },
            create: function () {
                //背景
                this.make.image({
                    x: 500,
                    y: 300,
                    key: "bg",

                    add: true,
                });
                //地板平台
                this.platforms = this.physics.add.staticGroup();
                this.platforms.create(500, 574, 'platform1').setScale(9).refreshBody();
                //設施平台
                this.platforms.create(760, 321, 'line1').setScale(1.65, 0.7) //洗手台
                this.platforms.create(154, 355, 'line1').setScale(1.4, 0.8) //馬桶
                this.platforms.create(490, 365, 'line5').setScale(1.2) //浴缸
                this.platforms.create(276.5, 185, 'line2').setScale(2.2, 0.8) //毛巾
                this.platforms.create(510, 109, 'line4').setScale() //浴簾
                this.platforms.create(39, 285, 'line3').setScale(1.8, 0.4) //衛生紙

                //小黴菌
                this.player = this.physics.add.sprite(50, 460, 'mold');
                this.player.setBounce(0.2);
                this.player.setCollideWorldBounds(true);
                this.anims.create({
                    key: 'left',
                    frames: this.anims.generateFrameNumbers('mold', {
                        start: 0,
                        end: 3
                    }),
                    frameRate: 10,
                    repeat: -1
                })
                this.anims.create({
                    key: 'turn',
                    frames: [{
                        key: 'mold',
                        frame: 4
                    }],
                    frameRate: 20
                })
                this.anims.create({
                    key: 'right',
                    frames: this.anims.generateFrameNumbers('mold', {
                        start: 5,
                        end: 8
                    }),
                    frameRate: 10,
                    repeat: -1
                })

                ouch = this.sound.add("ouch", {
                    volume: 0.5,
                    loop: false,
                    delay: -1
                });




                //子彈
                //bullets = this.add.group();
                //bullets.enableBody = true;
                //bullets.physicsBodyType = Phaser.Physics.ARCADE;
                //bullets.createMultiple(50, 'bullet');
                //bullets.setAll('anchor.x', 0.5);
                // bullets.setAll('anchor.y', 1);
                //bullets.setAll('outOfBoundsKill', true);
                //bullets.setAll('checkWorldBounds', true);
                //this.bullets.enableBody = true;
                //this.bullets.physicsBodyType = Phaser.Physics.ARCADE;
                //this.bullets.createMultiple(50, 'bullet');
                //this.bullets.setAll('anchor.x', 0.5);
                //this.bullets.setAll('anchor.y', 1);
                //this.bullets.setAll('outOfBoundsKill', true);
                //this.bullets.setAll('checkWorldBounds', true);

                //小小黴菌
                this.lilmolds = this.physics.add.group({
                    key: 'lilmold',
                    repeat: 4,
                    setXY: {
                        x: 100,
                        y: 0,
                        stepX: 200
                    }
                });
                this.lilmolds.children.iterate(function (child) {
                    child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
                });


                let bubbles;
                let score = 0;
                let scoreText;
                let lives = 5;
                let livesText;
                let restartText;
                let gameOver = false;

                this.add.image(20, 33, 'lilmold');
                scoreText = this.add.text(40, 16, ': 0', {
                    fontSize: '32px',
                    fill: '#000'
                });
                this.add.image(140, 33, 'mold').setScale(0.8);
                livesText = this.add.text(165, 16, ' lives: ' + lives, {
                    fontSize: '32px',
                    fill: '#000'
                });

                restartText = this.add.image(500, 300, "restart").setOrigin(0.5);
                restartText.visible = false;
                restartText.setInteractive().on('pointerdown', (pointer, localX, localY, event) => {
                    score = 0;
                    gameOver = false;
                    livesText.visible = false;
                    this.scene.restart();
                });


                // function restart() {
                //     resetMold();
                //     score = 0;
                //     lives = 1;
                // }

                // function resetMold() {
                //     mold.setPosition(50, 460);
                // }

                bubbles = this.physics.add.group();
                this.physics.add.collider(this.player, this.platforms);
                this.physics.add.collider(this.lilmolds, this.platforms);
                this.physics.add.collider(bubbles, this.platforms);
                this.physics.add.collider(this.player, bubbles, hitBubble, null, this);
                this.physics.add.overlap(this.player, this.lilmolds, collectlilmolds, null, this);

                function collectlilmolds(player, lilmolds) {
                    lilmolds.disableBody(true, true);
                    coin = this.sound.add("coin", {
                        volume: 0.5,
                        loop: false,
                        delay: 0
                    });
                    coin.play();
                    score += 1;
                    scoreText.setText(':' + score);
                    //泡泡跑出來
                    if (this.lilmolds.countActive(true) == 0) {
                        this.lilmolds.children.iterate(function (child) {
                            child.enableBody(true, child.x, 0, true, true);
                        });

                        let x = (player.x < 500) ? Phaser.Math.Between(500, 800) : Phaser.Math.Between(0,
                            500);
                        let bubble = bubbles.create(x, 16, 'bubble').setScale(0.5);
                        bubble.setBounce(1);
                        bubble.setCollideWorldBounds(true);
                        bubble.setVelocity(Phaser.Math.Between(-100, 100), 20);
                        bubble.allowGravity = false;

                    }

                    if (score >= 20) {
                        this.scene.start("stage2", 2000);
                        backgroundSound.setMute(true);
                    };
                };

                // 泡泡
                function hitBubble(player, bubble) {
                    //this.physics.pause();
                    //this.player.disableBody(true,false);
                    //this.player.setTint(0xff0000);
                    ouch.play();
                    //this.player.anims.play('turn');
                    lives--;
                    //livesText.setText('lives:'+lives);
                    //gameOver = true;

                    if (lives > 0) {
                        livesText.setText('lives：' + lives);
                    } else {
                        this.physics.pause();
                        this.player.disableBody(true, false);
                        this.player.setTint('rgba(0,0,0,0)');
                        backgroundSound.pause();
                        losesound = this.sound.add("losesound", {
                            volume: 0.5,
                            loop: false,
                            delay: 0
                        });
                        losesound.play();
                        restartText.setVisible(true);
                        restartText.setInteractive()
                            .on('pointerdown', (pointer) => {
                                if (pointer.leftButtonDown()) {
                                    //restartText.setBackgroundColor('grey');
                                    restartText.visible = false;
                                    backgroundSound.stop();
                                    restart();
                                    this.scene.restart();
                                }
                            })
                            .on('pointerover', () => {
                                this.add.image(500, 300, 'restart-2');
                            })
                            .on('pointerout', () => {
                                this.add.image(500, 300, 'restart');
                            });


                    }
                }
                const keyCodes = Phaser.Input.Keyboard.KeyCodes;
                this.left = this.input.keyboard.addKey(keyCodes.A);
                this.right = this.input.keyboard.addKey(keyCodes.D);
                this.W = this.input.keyboard.addKey(keyCodes.W);



                //背景音樂
                backgroundSound = this.sound.add("level1", {
                    volume: 0.5,
                    loop: true,
                    delay: 0
                });
                backgroundSound.play();
                let speaker = this.add.image(930, 50, 'on').setScale(0.05).setInteractive()
                    .on('pointerdown', () => {
                        if (speaker.texture.key == 'on') {
                            speaker.setTexture('off');
                        } else {
                            speaker.setTexture('on');
                        }
                        if (backgroundSound.mute) {
                            backgroundSound.setMute(false);
                        } else {
                            backgroundSound.setMute(true);
                        }
                    });
                //控制小黴菌
                this.cursors = this.input.keyboard.createCursorKeys();

            },

            update: function () {

                let gameOver = false;
                let restartText;
                if (this.left.isDown) {
                    this.player.setVelocityX(-160);
                    this.player.anims.play('left', true);
                } else if (this.right.isDown) {
                    this.player.setVelocityX(160);
                    this.player.anims.play('right', true);
                } else {
                    this.player.setVelocityX(0);
                    this.player.anims.play('turn');
                }

                if (this.W.isDown && this.player.body.touching.down) {
                    this.player.setVelocityY(-330);
                } else if (this.cursors.down.isDown) {
                    this.player.setVelocityY(330);
                }

                if (gameOver) {
                    restartText.setVisible(true);
                    console.log('遊戲結束，重新開始遊戲');
                }


            }

        });

        var bullets;
        var fireRate = 100;
        var nextFire = 0;
        var lastFired = 0;
        var speed;
        var cursors;
        var time;

        const stage2 = new Phaser.Class({

            Extends: Phaser.Scene,
            initialize: function stage() {
                this.direction = 1;
                Phaser.Scene.call(this, {
                    type: Phaser.AUTO,
                    scale: {
                        //mode: Phaser.Scale.FIT,
                        autoCenter: Phaser.Scale.CENTER_BOTH,
                        width: 1000,
                        height: 600
                    },
                    physics: {
                        default: "arcade",
                        arcade: {
                            gravity: {
                                y: 300
                            },
                            debug: false,
                        },
                    },
                    key: "stage2"
                });
            },
            preload: function () {
                this.load.image("bg", "./assets/img/background.png")
                this.load.image("lilmold", "./assets/img/lilmold.png")
                this.load.image("bubble", "./assets/img/bubble.png")
                this.load.image("soap", "./assets/img/soap.png")
                this.load.image("platform1", "./assets/img/platform1.png")
                this.load.image("line1", "./assets/img/line1.png")
                this.load.image("line2", "./assets/img/line2.png")
                this.load.image("line3", "./assets/img/line3.png")
                this.load.image("line4", "./assets/img/line4.png")
                this.load.image("line5", "./assets/img/line5.png")
                this.load.image("on", "./assets/img/voiceon.png");
                this.load.image("off", "./assets/img/voiceoff.png");
                this.load.image("restart", "./assets/img/restart.png");
                this.load.image("restart-2", "./assets/img/restart-2.png");
                this.load.image("boss-2", "./assets/img/boss-2.png");
                this.load.image("win", "./assets/img/win.png");
                this.load.spritesheet('mold', './assets/img/mold.png', {
                    frameWidth: 83,
                    frameHeight: 55
                })
                this.load.audio("menu", "./assets/audio/menu.mp3")
                this.load.audio("level1", "./assets/audio/level1bgm.mp3")
                this.load.audio("losesound", "./assets/audio/Losesound.mp3")
                this.load.audio("ouch", "./assets/audio/ouch.mp3")
                this.load.audio("coin", "./assets/audio/coin01.mp3")
                this.load.audio("bossbgm", "./assets/audio/bossmusic.mp3")
                this.load.audio("fireaudio", "./assets/audio/fireaudio.mp3")
                this.load.audio("win", "./assets/audio/win.mp3")
                this.load.spritesheet('boss', './assets/img/boss3.png', {
                    frameWidth: 93,
                    frameHeight: 114
                })
                this.load.image('bullet', "./assets/img/bullet.png")
                var time;
                var bullets;
                var speed;
                var stats;
                var lastFired = 0;
            },
            create: function () {
                //背景
                this.make.image({
                    x: 500,
                    y: 300,
                    key: "bg",

                    add: true,
                });
                //地板平台
                this.platforms = this.physics.add.staticGroup();
                this.platforms.create(500, 574, 'platform1').setScale(9).refreshBody();
                //設施平台
                this.platforms.create(760, 321, 'line1').setScale(1.65, 0.7) //洗手台
                this.platforms.create(154, 355, 'line1').setScale(1.4, 0.8) //馬桶
                this.platforms.create(490, 365, 'line5').setScale(1.2) //浴缸
                this.platforms.create(276.5, 185, 'line2').setScale(2.2, 0.8) //毛巾
                this.platforms.create(510, 109, 'line4').setScale() //浴簾
                this.platforms.create(39, 285, 'line3').setScale(1.8, 0.4) //衛生紙

                //小黴菌
                this.player = this.physics.add.sprite(50, 460, 'mold');
                this.player.setBounce(0.2);
                this.player.setCollideWorldBounds(true);
                this.player.direction = 'right';
                this.anims.create({
                    key: 'left',
                    frames: this.anims.generateFrameNumbers('mold', {
                        start: 0,
                        end: 3
                    }),
                    frameRate: 10,
                    repeat: -1
                })
                this.anims.create({
                    key: 'turn',
                    frames: [{
                        key: 'mold',
                        frame: 4
                    }],
                    frameRate: 20
                })
                this.anims.create({
                    key: 'right',
                    frames: this.anims.generateFrameNumbers('mold', {
                        start: 5,
                        end: 8
                    }),
                    frameRate: 10,
                    repeat: -1
                })
                this.bullets = this.physics.add.group({
                    defaultKey: "bullet",
                    allowGravity: false,
                    immovable: true,
                    frameQuantity: 5
                    //maxSize: 10
                });
                this.bullets.children.iterate(function (child) {
                    child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
                    if(this.left.isDown || this.player.direction === 'left'){
                        score-=1;
                    scoreText.setText(':' + score);
                    }
                    this.right.isDown || this.player.direction === 'right'
                    if(this.right.isDown || this.player.direction === 'right'){
                        score-=1;
                    scoreText.setText(':' + score);
                    }
                });
                this.anims.create({
                    key: "fire",
                     frames: this.anims.generateFrameNumbers("bullet", {
                         start: 0,
                         end: 1
                     })
                });
                this.input.on("pointerdown", this.shootBullet, this);

                //控制小黴菌
                this.cursors = this.input.keyboard.createCursorKeys();

                this.lilmolds = this.physics.add.group({
                    key: 'lilmold',
                    repeat: 4,
                    setXY: {
                        x: 150,
                        y: 0,
                        stepX: 200
                    }
                });
                this.lilmolds.children.iterate(function (child) {
                    child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
                });

                this.boss = this.physics.add.sprite(500, 50, 'boss');
                this.boss.setBounce(0.2);
                this.boss.setCollideWorldBounds(true);
                this.anims.create({
                    key: 'runleft',
                    frames: this.anims.generateFrameNumbers('boss', {
                        start: 0,
                        end: 3
                    }),
                    frameRate: 10,
                    repeat: -1
                })
                this.anims.create({
                    key: 'front',
                    frames: [{
                        key: 'boss',
                        frame: 4
                    }],
                    frameRate: 20
                })
                this.anims.create({
                    key: 'runright',
                    frames: this.anims.generateFrameNumbers('boss', {
                        start: 5,
                        end: 8
                    }),
                    frameRate: 10,
                    repeat: -1
                })

                ouch = this.sound.add("ouch", {
                    volume: 0.5,
                    loop: false,
                    delay: -1
                });

                this.boss.anims.play('front');
                //子彈


                //bullets = this.physics.add.group();
                //this.spaceKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
                //bullets = this.add.group();
                //bullets.enableBody = true;
                //bullets.physicsBodyType = Phaser.Physics.ARCADE;
                //bullets.createMultiple(50, 'bullet');
                //bullets.setAll('checkWorldBounds', true);
                //bullets.setAll('outOfBoundsKill', true);
                //bullets.setAll('anchor.x', 0.5);
                //bullets.setAll('anchor.y', 1);
                //this.nextShotAt = 0;
                //this.shotDelay = 100;
                //bullets = this.physics.add.group({ classType: Bullet, runChildUpdate: true });
                //this.physics.add.overlap(boss, bullet);
                let bubbles;
                let boss;
                let score = 20;
                let scoreText;
                let lives = 10;
                let lives2 = 15;
                let livesText;
                let livesText2;
                let restartText;
                let gameOver = false;
                let winText;
               
                this.add.image(20, 33, 'lilmold');
                scoreText = this.add.text(40, 16, ': ' + score, {
                    fontSize: '32px',
                    fill: '#000'
                });
                this.add.image(140, 33, 'mold').setScale(0.8);
                livesText = this.add.text(165, 16, ' lives: ' + lives, {
                    fontSize: '32px',
                    fill: '#000'
                });
                this.add.image(690, 33, 'boss-2').setScale(0.1);
                livesText2 = this.add.text(710, 16, ' lives: ' + lives2, {
                    fontSize: '32px',
                    fill: '#000'
                });
                restartText = this.add.image(500, 300, "restart").setOrigin(0.5);
                restartText.visible = false;
                winText = this.add.image(500, 300, "win").setOrigin(0.5);
                winText.visible = false;
                restartText.setInteractive().on('pointerdown', (pointer, localX,
                    localY,
                    event) => {
                    score = 0;
                    gameOver = false;
                    livesText.visible = false;
                    this.scene.start("stage2", 2000);
                });

                // function restart() {
                //     resetMold();
                //     score = 0;
                //     lives = 1;
                // }

                // function resetMold() {
                //     mold.setPosition(50, 460);
                // }
                
                bubbles = this.physics.add.group();
                this.physics.add.collider(this.player, this.platforms);
                this.physics.add.collider(this.lilmolds, this.platforms);
                this.physics.add.collider(bubbles, this.platforms);
                this.physics.add.collider(this.boss, this.platforms);
                this.physics.add.collider(this.player, bubbles, hitBubble, null, this);
                this.physics.add.collider(this.player, this.boss, hitBoss, null, this);
                this.physics.add.overlap(this.player, this.lilmolds, collectlilmolds, null, this);
                this.physics.add.overlap(this.boss, this.bullets, BulletHitboss, null, this);
                // this.physics.add.overlap(this.player, this.bullets, BulletHitplayer, null, this);
                // if(this.left.isDown || this.player.direction === 'left'){
                //         score-=1;
                //     scoreText.setText(':' + score);
                //     }
                //     this.right.isDown || this.player.direction === 'right'
                //     if(this.right.isDown || this.player.direction === 'right'){
                //         score-=1;
                //     scoreText.setText(':' + score);
                //     }
                // function BulletHitplayer(boss, bullets) {
                    
                //     score-=1;
                //     scoreText.setText(':' + score);
                   
                //     // setTimeout(() => (scoreText = false), 500);
                // }
                
                function BulletHitboss(boss, bullets) {
                    lives2--;
                    this.boss.setTint(0x00ff00);
                    score-=1;
                    scoreText.setText(':' + score);
                    bullets.disableBody(true, true);
                    if (lives2 > 0) {
                    livesText2.setText('lives：' + lives2);
                } else {
                    game. sound. stopAll();
                    boss.disableBody(true, true);
                    winText.setVisible(true);
                    win = this.sound.add("win", {
                        volume: 0.1,
                        loop: false,
                        delay: 0
                    });
                    win.play();
                    this.physics.pause();
                    this.player.disableBody(true, false);
                    this.boss.disableBody(true, false);
                    winText.setInteractive()
                        .on('pointerdown', (pointer) => {
                            if (pointer.leftButtonDown()) {
                                winText = false;
                                this.scene.start("menu", 2000);
                            }
                        })
                        
                }
            }

                function collectlilmolds(player, lilmolds) {
                    lilmolds.disableBody(true, true);
                    coin = this.sound.add("coin", {
                        volume: 0.5,
                        loop: false,
                        delay: 0
                    });
                    coin.play();
                    score += 1;
                    scoreText.setText(':' + score);
                    //泡泡跑出來
                    if (this.lilmolds.countActive(true) === 0) {
                        this.lilmolds.children.iterate(function (child) {
                            child.enableBody(true, child.x, 0, true, true);
                        });
                        let x = (player.x < 500) ? Phaser.Math.Between(500, 800) :
                            Phaser.Math
                            .Between(0,
                                500);
                        let bubble = bubbles.create(x, 16, 'bubble').setScale(0.5);
                        bubble.setBounce(1);
                        bubble.setCollideWorldBounds(true);
                        bubble.setVelocity(Phaser.Math.Between(-100, 100), 20);
                        bubble.allowGravity = false;
                    }
                };

                //boss

                // 泡泡
                function hitBubble(player, bubble) {
                    //this.physics.pause();
                    //this.player.disableBody(true,false);
                    //this.player.setTint(0xff0000);
                    ouch.play();
                    //this.player.anims.play('turn');
                    lives--;

                    //livesText.setText('lives:'+lives);
                    //gameOver = true;

                    if (lives > 0) {
                        livesText.setText('lives：' + lives);
                    } else {
                        this.physics.pause();
                        this.player.disableBody(true, false);
                        this.boss.disableBody(true, false);
                        this.player.setTint('rgba(0,0,0,0)');
                        backgroundSound.pause();
                        losesound = this.sound.add("losesound", {
                            volume: 0.5,
                            loop: false,
                            delay: 0
                        });
                        losesound.play();
                        restartText.setVisible(true);
                        restartText.setInteractive()
                            .on('pointerdown', (pointer) => {
                                if (pointer.leftButtonDown()) {
                                    //restartText.setBackgroundColor('grey');
                                    restartText.visible = false;
                                    backgroundSound.stop();
                                    restart();
                                    this.scene.restart();
                                }
                            })
                            .on('pointerover', () => {
                                this.add.image(500, 300, 'restart-2');
                            })
                            .on('pointerout', () => {
                                this.add.image(500, 300, 'restart');
                            });
                    }

                }

                //子彈

                // var Bullet = new Phaser.Class({

                // Extends: Phaser.GameObjects.Image,

                // initialize:

                //   function Bullet(scene) {
                //     Phaser.GameObjects.Image.call(this, scene, 0, 0,
                //        'bullet');

                //     this.speed = Phaser.Math.GetSpeed(500, 1);
                /// },

                // fire: function (x, y) {
                //    this.setPosition(x, y - 20);
                //    this.setActive(true);
                //     this.setVisible(true);

                // },

                //   update: function (time, delta) {
                //    if (this.cursors.left.isDown || this.player.direction === 'left') {
                //       this.x -= this.speed * delta;
                ///   } else if (this.cursors.right.isDown || this.player.direction ===
                //       'right') {
                ////        this.x += this.speed * delta;
                //    }

                //   if (this.x > 1000) {
                //       this.setActive(false);
                //       this.setVisible(false);
                //   } else if (this.x < 0) {
                //        this.setActive(false);
                //        this.setVisible(false);
                //    }

                //  }

                //});




                
                function hitBoss(player, boss) {
                    lives--;
                    ouch.play();
                    if (lives > 0) {
                        livesText.setText('lives：' + lives);
                    } else {
                        this.physics.pause();
                        this.player.disableBody(true, false);
                        this.boss.disableBody(true, false);
                        this.player.setTint('rgba(0,0,0,0)');
                        game. sound. stopAll();
                        losesound = this.sound.add("losesound", {
                            volume: 0.5,
                            loop: false,
                            delay: 0
                        });
                        losesound.play();
                        restartText.setVisible(true);
                        restartText.setInteractive()
                            .on('pointerdown', (pointer) => {
                                if (pointer.leftButtonDown()) {
                                    //restartText.setBackgroundColor('grey');
                                    restartText.visible = false;
                                    backgroundSound.stop();
                                    // restart();
                                    this.scene.restart();
                                }
                            })
                            .on('pointerover', () => {
                                this.add.image(500, 300, 'restart-2');
                            })
                            .on('pointerout', () => {
                                this.add.image(500, 300, 'restart');
                            });
                    }
                }
                const keyCodes = Phaser.Input.Keyboard.KeyCodes;
                this.left = this.input.keyboard.addKey(keyCodes.A);
                this.right = this.input.keyboard.addKey(keyCodes.D);
                this.W = this.input.keyboard.addKey(keyCodes.W);
                // function render() {

                //     game.debug.text('Active Bullets: ' + bullets.countLiving() +
                //         ' / ' + bullets
                //         .total, 32,
                //         32);

                // }

                //背景音樂
                backgroundSound = this.sound.add("bossbgm", {
                    volume: 0.3,
                    loop: true,
                    delay: 0
                });
                backgroundSound.play();
                let speaker = this.add.image(930, 50, 'on').setScale(0.05)
                    .setInteractive()
                    .on('pointerdown', () => {
                        if (speaker.texture.key == 'on') {
                            speaker.setTexture('off');
                        } else {
                            speaker.setTexture('on');
                        }
                        if (backgroundSound.mute) {
                            backgroundSound.setMute(false);
                        } else {
                            backgroundSound.setMute(true);
                        }
                    });

            },
            
            shootBullet() {
                let x = this.player.x + 18

                if (this.player.direction === 'left') {
                    x = this.player.x -18
                }
                let bullet = this.bullets.get(x, this.player.y + 5);
                if (bullet) {
                    bullet.setActive(true);
                    bullet.setVisible(true);
                    
                    if (this.left.isDown || this.player.direction === 'left') {
                        
                        bullet.body.velocity.x = -300;
                       // bullet.anims.play("fire");
                        fireaudio = this.sound.add("fireaudio", {
                        volume: 0.2,
                        loop: false,
                        delay: 0
                    });
                    fireaudio.play();
                   
                       
                    } else if (this.right.isDown || this.player.direction === 'right') {
                        bullet.body.velocity.x = 300;
                        //bullet.anims.play("fire");
                        fireaudio = this.sound.add("fireaudio", {
                        volume: 0.2,
                        loop: false,
                        delay: 0
                    });
                    fireaudio.play();
                   
                    
                    } else {
                        // T.T
                        bullet.body.velocity.x = 300;
                       // bullet.anims.play("fire");
                        fireaudio = this.sound.add("fireaudio", {
                        volume: 0.2,
                        loop: false,
                        delay: 0
                    });
                    fireaudio.play();
                    
                    // score--;
                    // scoreText.setText(':' + score);
                    }

                }
            },
            update: function (time, delta) {
                let gameOver = false;
                let restartText;
                if (this.left.isDown) {
                    this.player.setVelocityX(-160);
                    this.player.anims.play('left', true);
                    this.player.flipX = true;
                } else if (this.right.isDown) {
                    this.player.setVelocityX(160);
                    this.player.flipX = false;
                    this.player.anims.play('right', true);
                } else {
                    this.player.setVelocityX(0);
                    this.player.anims.play('turn');
                }

                if (this.W.isDown && this.player.body.touching.down) {
                    this.player.setVelocityY(-330);
                }

                if (gameOver) {
                    restartText.setVisible(true);
                    console.log('遊戲結束');
                }
                this.physics.moveToObject(this.boss, this.player, 100);
                if (this.boss.body.touching.down) {
                    if (this.player.x < this.boss.x) {
                        this.boss.setVelocityX(Phaser.Math.Between(-100, 0));
                        this.boss.setVelocityX(-60);
                        this.boss.anims.play('runleft', true);
                    } else if (this.boss.setVelocityX(Phaser.Math.Between(0, 100))) {
                        this.boss.setVelocityX(60);
                        this.boss.anims.play('runright', true);
                    }
                }

                function enemyFollows() {
                    this.boss.x = this.player.body.position.x;
                    this.boss.y = this.player.body.position.y;
                }
                //子彈
                //if (this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE).isDown && time >
                //    lastFired) {
                //    var bullet = bullets.get();


                //    if (bullet) {
                //        bullet.fire(this.player.x, this.player.y);
                //        lastFired = time + 150; //子彈之間間隔

                //    }
                //    coin--;
                //}
            }

        });



        var menuBgMusic;
        const menu = new Phaser.Class({
            Extends: Phaser.Scene,
            initialize: function menu() {
                Phaser.Scene.call(this, {
                    key: "menu"
                });
            },
            preload: function () {
                this.load.audio("menu", "./assets/audio/menu.mp3");
                this.load.image("menubg", "./assets/img/menubg.jpeg");
                this.load.image("play", "./assets/img/play.png");
                this.load.image("start", "./assets/img/start.png");
                this.load.image("start-2", "./assets/img/start-2.png");
                this.load.image("story", "./assets/img/story.png");
                this.load.image("on", "./assets/img/voiceon.png");
                this.load.image("off", "./assets/img/voiceoff.png");


            },
            create: function () {
                //大廳背景音樂
                menuBgMusic = this.sound.add("menu", {
                    volume: 0.5,
                    loop: true,
                    delay: 0
                });
                // 播放背景音樂
                menuBgMusic.play();

                //背景顏色
                this.make.image({
                    x: 500,
                    y: 300,
                    backgroundColor: '#c1d3d9',
                    key: "menubg",
                    add: true,
                });
                let speaker = this.add.image(920, 50, 'on').setScale(0.06)
                    .setInteractive()
                    .on('pointerdown', () => {
                        if (speaker.texture.key == 'on') {
                            speaker.setTexture('off');
                        } else {
                            speaker.setTexture('on');
                        }
                        if (menuBgMusic.mute) {
                            menuBgMusic.setMute(false);
                        } else {
                            menuBgMusic.setMute(true);
                        }
                    });
                //按鈕跟標題

                //startBtn = this.add.sprite(500,450,'start');
                play = this.add.sprite(165, 550, 'play').setInteractive()
                    .on('pointerdown', () => {
                        this.scene.start("gameplay");
                    });
                storyBtn = this.add.sprite(70, 550, 'story').setInteractive()
                    .on('pointerdown', () => {
                        this.scene.start("gamestory");
                    });
                //開始遊戲
                startBtn = this.add.sprite(830, 530, 'start').setInteractive().setScale(0.8)
                    .on('pointerdown', () => {
                        menuBgMusic.stop();
                        this.scene.start("stage");
                    })
                    .on('pointerover', () => {
                        this.add.image(830, 530, 'start-2').setScale(0.8);

                    })
                    .on('pointerout', () => {
                        this.add.image(830, 530, 'start').setScale(0.8);
                    });
                /*this.input.once("pointerdown",function (event) {
                        menuBgMusic.stop();
                        this.scene.start("stage");
                    },this);*/
            },
            update: function () {}
        });


        var menuBgMusic;
        const gamestory = new Phaser.Class({
            Extends: Phaser.Scene,
            initialize: function gamestory() {
                Phaser.Scene.call(this, {
                    key: "gamestory"
                });
            },
            preload: function () {
                this.load.audio("menu", "./assets/audio/menu.mp3");
                this.load.image("menubg", "./assets/img/menubg.jpeg");
                this.load.image("story2", "./assets/img/story-2.png");
                this.load.image("close", "./assets/img/close.png");
            },
            create: function () {
                /*menuBgMusic = this.sound.add("menu", {
                    volume: 0.5,
                    loop: true,
                    delay: 0
                });*/
                //menuBgMusic.play();
                this.make.image({
                    x: 500,
                    y: 300,
                    backgroundColor: '#c1d3d9',
                    key: "menubg",
                    add: true,
                });
                story2 = this.add.sprite(500, 280, 'story2');
                closeBtn = this.add.sprite(910, 90, 'close').setInteractive()
                    .on('pointerdown', () => {
                        menuBgMusic.stop();
                        this.scene.start("menu");

                    });
            },
            update: function () {}
        });

        var menuBgMusic;
        const gameplay = new Phaser.Class({
            Extends: Phaser.Scene,
            initialize: function gameplay() {
                Phaser.Scene.call(this, {
                    key: "gameplay"
                });
            },
            preload: function () {
                this.load.audio("menu", "./assets/audio/menu.mp3");
                this.load.image("menubg", "./assets/img/menubg.jpeg");
                this.load.image("play2", "./assets/img/play-2.png");
                this.load.image("close", "./assets/img/close.png");
            },
            create: function () {
                /*menuBgMusic = this.sound.add("menu", {
                    volume: 0.5,
                    loop: true,
                    delay: 0
                });*/
                //menuBgMusic.play();
                this.make.image({
                    x: 500,
                    y: 300,
                    backgroundColor: '#c1d3d9',
                    key: "menubg",
                    add: true,
                });
                play2 = this.add.sprite(500, 280, 'play2');
                closeBtn = this.add.sprite(910, 90, 'close').setInteractive()
                    .on('pointerdown', () => {
                        menuBgMusic.stop();
                        this.scene.start("menu");

                    });
            },
            update: function () {}
        });

        const config = {
            type: Phaser.AUTO,
            scale: {
                //mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH,
                width: 1000,
                height: 600,
            },
            audio: {
                disableWebAudio: false,
            },
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: {},
                    debug: false
                },
            },
            scene: [menu, stage, gamestory, gameplay, stage2]
        };
        var game = new Phaser.Game(config);
    </script>


</head>

<body>

</body>

</html>